<Window x:Class="CheckpointApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:viewmodels="clr-namespace:CheckpointApp.ViewModels"
        xmlns:helpers="clr-namespace:CheckpointApp.Helpers"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type={x:Type viewmodels:MainViewModel}, IsDesignTimeCreatable=False}"
        Title="{Binding WindowTitle}" Height="800" Width="1388"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <Style TargetType="ListViewItem" x:Key="CrossingListViewItemStyle">
            <Setter Property="Foreground" Value="Black" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsOnWatchlist}" Value="True">
                    <Setter Property="Background" Value="#7D5C00"/>
                    <Setter Property="Foreground" Value="White"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsOnWantedList}" Value="True">
                    <Setter Property="Background" Value="#6B0000"/>
                    <Setter Property="Foreground" Value="White"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                    <Setter Property="TextBlock.TextDecorations" Value="Strikethrough"/>
                    <Setter Property="Foreground" Value="Gray"/>
                    <Setter Property="ToolTip" Value="Эта запись помечена как ошибочная и не учитывается в статистике."/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_Файл">
                <MenuItem Header="_Сохранить пересечение" Command="{Binding SaveCrossingCommand}"/>
                <MenuItem Header="_Очистить форму" Command="{Binding ClearFormCommand}"/>
                <Separator/>
                <MenuItem Header="_Запрос на лицо..." Command="{Binding GeneratePersonReportCommand}"/>
                <MenuItem Header="_Экспорт в Excel..." Command="{Binding ExportToExcelCommand}"/>
                <Separator/>
                <MenuItem Header="_Сменить оператора" Command="{Binding SwitchUserCommand}"/>
                <MenuItem Header="_Выход" Command="{Binding ExitCommand}"/>
            </MenuItem>
            <MenuItem Header="_Инструменты">
                <MenuItem Header="_Обновить данные" Command="{Binding RefreshDataCommand}"/>
                <MenuItem Header="_Лица в погранзоне" Command="{Binding ShowPeopleInZoneCommand}"/>
                <MenuItem Header="_Аналитика" Command="{Binding ShowAnalyticsCommand}"/>
                <Separator/>
                <MenuItem Header="_Список розыска" Command="{Binding ManageWantedListCommand}"/>
                <MenuItem Header="_Список наблюдения" Command="{Binding ManageWatchlistCommand}"/>
            </MenuItem>
            <MenuItem Header="_Администрирование" Visibility="{Binding IsAdmin, Converter={StaticResource BooleanToVisibilityConverter}}">
                <MenuItem Header="_Управление пользователями" Command="{Binding ManageUsersCommand}"/>
            </MenuItem>
            <MenuItem Header="_Справка">
                <MenuItem Header="_О программе" Command="{Binding ShowAboutInfoCommand}"/>
            </MenuItem>
        </Menu>

        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <Button Content="Сохранить" Command="{Binding SaveCrossingCommand}"/>
                <Button Content="Очистить" Command="{Binding ClearFormCommand}"/>
                <Button Content="Обновить" Command="{Binding RefreshDataCommand}"/>
                <Button Content="Удалить" Command="{Binding DeleteCrossingCommand}" Background="#FFC1C1"/>
                <Separator/>
                <Button Command="{Binding ProactiveSecurityCheckCommand}" 
                        Padding="5,2" FontWeight="Bold" Background="#FFF2CC"
                        ToolTip="Заполните Фамилию, Имя и Дату рождения, затем нажмите для проверки по спискам без сохранения.">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Предварительная проверка"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button Content="Товары/Грузы" Command="{Binding ShowGoodsWindowCommand}"/>
            </ToolBar>
        </ToolBarTray>

        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <Border Background="{Binding SecurityCheckColor}" CornerRadius="5" Padding="10,2" Margin="0,0,5,0">
                    <TextBlock Text="{Binding SecurityCheckStatus}" Foreground="Black"/>
                </Border>
            </StatusBarItem>
        </StatusBar>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- ~ ~ ~ ИЗМЕНЕНИЕ: Панель статистики перестроена для лучшей читаемости ~ ~ ~ -->
            <Border Grid.Row="0" Margin="5" Padding="5" BorderBrush="LightGray" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Верхняя строка: Фильтр по дате и времени -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Left">
                        <TextBlock Text="Статистика за период:" FontWeight="Bold" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding DashboardStartDate}" Margin="5,0" VerticalAlignment="Center"/>
                        <xctk:TimePicker Value="{Binding DashboardStartTime}" Format="ShortTime" Margin="0,0,5,0" VerticalAlignment="Center"/>
                        <TextBlock Text="-" VerticalAlignment="Center"/>
                        <DatePicker SelectedDate="{Binding DashboardEndDate}" Margin="5,0" VerticalAlignment="Center"/>
                        <xctk:TimePicker Value="{Binding DashboardEndTime}" Format="ShortTime" Margin="0,0,5,0" VerticalAlignment="Center"/>
                        <Button Content="Применить" Command="{Binding UpdateAllDashboardStatsCommand}" Margin="5,0" Padding="5,0"/>
                    </StackPanel>

                    <!-- Нижняя строка: Сводные данные -->
                    <WrapPanel Grid.Row="1" Margin="0,8,0,0">
                        <!-- Статистика за период -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,20,0">
                            <TextBlock Text="Въехало:" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding EnteredPersonsCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="чел. /" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding EnteredVehiclesCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="тс" VerticalAlignment="Center"/>
                        </StackPanel>
                        <Separator Margin="10,0" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,20,0">
                            <TextBlock Text="Выехало:" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ExitedPersonsCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="чел. /" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ExitedVehiclesCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="тс" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Общая статистика -->
                        <Separator Margin="10,0" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,20,0">
                            <TextBlock Text="В погранзоне:" VerticalAlignment="Center" FontWeight="Bold"/>
                            <TextBlock Text="{Binding PersonsInZoneCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center" Foreground="Blue"/>
                            <TextBlock Text="чел. /" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding VehiclesInZoneCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center" Foreground="Blue"/>
                            <TextBlock Text="тс" VerticalAlignment="Center"/>
                        </StackPanel>
                        <Separator Margin="10,0" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,20,0">
                            <TextBlock Text="В розыске:" VerticalAlignment="Center" FontWeight="Bold"/>
                            <TextBlock Text="{Binding WantedPersonsTotalCount}" FontWeight="Bold" Margin="5,0" VerticalAlignment="Center" Foreground="Red"/>
                            <TextBlock Text="чел." VerticalAlignment="Center"/>
                        </StackPanel>
                    </WrapPanel>
                </Grid>
            </Border>
            <!-- ~ ~ ~ КОНЕЦ ИЗМЕНЕНИЯ ~ ~ ~ -->

            <Grid Grid.Row="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- ФОРМА ВВОДА -->
                <TabControl Grid.Row="0" Margin="5">
                    <TabItem Header="Личные данные">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="5">
                                <Label Content="Фамилия:"/>
                                <TextBox Text="{Binding CurrentPerson.LastName, UpdateSourceTrigger=PropertyChanged}"/>
                                <Label Content="Имя:"/>
                                <TextBox Text="{Binding CurrentPerson.FirstName, UpdateSourceTrigger=PropertyChanged}"/>
                                <Label Content="Отчество:"/>
                                <TextBox Text="{Binding CurrentPerson.Patronymic, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="5">
                                <Label Content="Гражданство:"/>
                                <ComboBox IsEditable="True" ItemsSource="{Binding AllCitizenships}" Text="{Binding CurrentPerson.Citizenship, UpdateSourceTrigger=PropertyChanged}"/>
                                <Label Content="Паспортные данные:"/>
                                <TextBox Text="{Binding CurrentPerson.PassportData, UpdateSourceTrigger=PropertyChanged}"/>
                                <Label Content="Дата рождения:"/>
                                <DatePicker SelectedDate="{Binding CurrentPersonDob}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="5">
                                <Label Content="Примечания:"/>
                                <TextBox Text="{Binding CurrentPerson.Notes}" Height="100" TextWrapping="Wrap" AcceptsReturn="True"/>
                            </StackPanel>
                        </Grid>
                    </TabItem>
                    <TabItem Header="Детали пересечения">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="5">
                                <GroupBox Header="Направление">
                                    <StackPanel Orientation="Horizontal" Margin="15,5,5,5">
                                        <RadioButton Content="Въезд" IsChecked="{Binding IsDirectionIn}" Margin="5"/>
                                        <RadioButton Content="Выезд" IsChecked="{Binding IsDirectionOut}" Margin="25,5,5,5"/>
                                    </StackPanel>
                                </GroupBox>
                                <Label Content="Тип пересечения:"/>
                                <ComboBox ItemsSource="{Binding CrossingTypes}" SelectedItem="{Binding SelectedCrossingType}"/>
                                <Label Content="Цель:"/>
                                <ComboBox IsEditable="True" ItemsSource="{Binding AllPurposes}" Text="{Binding CurrentCrossing.Purpose, UpdateSourceTrigger=PropertyChanged}"/>
                                <Label Content="НП Следования:"/>
                                <ComboBox IsEditable="True" ItemsSource="{Binding AllDestinations}" Text="{Binding CurrentCrossing.DestinationTown, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>
                            <GroupBox Grid.Column="1" Header="Транспортное средство" Margin="5" IsEnabled="{Binding IsVehicleInfoEnabled}">
                                <StackPanel>
                                    <Label Content="Марка:"/>
                                    <ComboBox IsEditable="True" ItemsSource="{Binding AllVehicleMakes}" Text="{Binding CurrentVehicle.Make, UpdateSourceTrigger=PropertyChanged}"/>
                                    <Label Content="Гос. номер:"/>
                                    <TextBox Text="{Binding CurrentVehicle.LicensePlate, UpdateSourceTrigger=PropertyChanged}"/>
                                </StackPanel>
                            </GroupBox>
                        </Grid>
                    </TabItem>
                </TabControl>

                <!-- ЖУРНАЛ ПЕРЕСЕЧЕНИЙ -->
                <ListView Grid.Row="1" Margin="5" ItemsSource="{Binding CrossingsView}" SelectedItem="{Binding SelectedCrossing}"
                          ItemContainerStyle="{StaticResource CrossingListViewItemStyle}">
                    <ListView.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Редактировать личные данные" Command="{Binding EditPersonCommand}"/>
                            <MenuItem Header="Посмотреть историю пересечений" Command="{Binding ShowPersonHistoryCommand}"/>
                        </ContextMenu>
                    </ListView.ContextMenu>
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="MouseDoubleClick">
                            <i:InvokeCommandAction Command="{Binding DoubleClickOnCrossingCommand}" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="ID" DisplayMemberBinding="{Binding ID}" Width="50"/>
                            <GridViewColumn Header="Дата и время" DisplayMemberBinding="{Binding Timestamp}" Width="140"/>
                            <GridViewColumn Header="ФИО" DisplayMemberBinding="{Binding FullName}" Width="220"/>
                            <GridViewColumn Header="Дата рожд." DisplayMemberBinding="{Binding PersonDob}" Width="90"/>
                            <GridViewColumn Header="Паспорт" DisplayMemberBinding="{Binding PersonPassport}" Width="100"/>
                            <GridViewColumn Header="Направл." DisplayMemberBinding="{Binding Direction}" Width="70"/>
                            <GridViewColumn Header="Тип" DisplayMemberBinding="{Binding CrossingType}" Width="80"/>
                            <GridViewColumn Header="ТС" DisplayMemberBinding="{Binding VehicleInfo}" Width="150"/>
                            <GridViewColumn Header="Цель" DisplayMemberBinding="{Binding Purpose}" Width="100"/>
                            <GridViewColumn Header="НП Следования" DisplayMemberBinding="{Binding DestinationTown}" Width="120"/>
                            <GridViewColumn Header="Оператор" DisplayMemberBinding="{Binding OperatorUsername}" Width="100"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>
        </Grid>
    </DockPanel>
</Window>
